<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Borsa Takip Robotu v1</title>
    <!-- Tailwind CSS (Tasarım İçin) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome (İkonlar İçin) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Özel Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .glass {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Demo Modu Uyarısı */
        .demo-badge {
            background: #f59e0b;
            color: #000;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            display: none; /* Başlangıçta gizli */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans antialiased min-h-screen">

    <!-- ÜST BAR -->
    <nav class="glass sticky top-0 z-50 border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-robot text-blue-500 text-2xl"></i>
                    <div class="flex flex-col">
                        <span class="font-bold text-xl tracking-wider leading-none">V1N<span class="text-blue-500">FU</span></span>
                        <span id="demoBadge" class="demo-badge">DEMO MODU</span>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div id="connectionStatus" class="flex items-center gap-2 text-sm text-gray-400">
                        <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> Bağlantı Bekleniyor...
                    </div>
                    <button onclick="verileriGetir()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition flex items-center gap-2">
                        <i class="fa-solid fa-rotate"></i> Yenile
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- HATA / BİLGİ MESAJI ALANI -->
    <div id="messageArea" class="max-w-[1600px] mx-auto mt-4 px-6 hidden">
        <div class="bg-yellow-500/10 border border-yellow-500/50 text-yellow-200 p-4 rounded-lg flex items-start gap-3">
            <i class="fa-solid fa-triangle-exclamation mt-1"></i>
            <div>
                <h3 class="font-bold">Bağlantı Hatası - Demo Veriler Gösteriliyor</h3>
                <p class="text-sm opacity-80">Yerel API'ye (localhost) ulaşılamadı. Bu durum önizleme ekranında normaldir. Dosyayı bilgisayarınıza kaydedip açtığınızda ve C# uygulamasını çalıştırdığınızda gerçek veriler gelecektir.</p>
            </div>
        </div>
    </div>

    <div class="max-w-[1600px] mx-auto p-6 grid grid-cols-12 gap-6">
        
        <!-- SOL PANEL: FİLTRELER -->
        <div class="col-span-12 lg:col-span-3 space-y-6">
            <div class="glass rounded-xl p-5">
                <h2 class="text-lg font-semibold mb-4 border-b border-gray-700 pb-2 flex items-center gap-2">
                    <i class="fa-solid fa-filter text-blue-400"></i> Filtreler
                </h2>
                
                <div class="space-y-4">
                    <!-- Temel Analiz -->
                    <div>
                        <label class="text-xs text-gray-400 uppercase font-bold mb-2 block">Temel Analiz</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="number" id="minFk" placeholder="Min F/K" class="bg-gray-800 border border-gray-700 rounded p-2 text-sm w-full focus:border-blue-500 outline-none">
                            <input type="number" id="maxFk" placeholder="Max F/K" class="bg-gray-800 border border-gray-700 rounded p-2 text-sm w-full focus:border-blue-500 outline-none">
                            <input type="number" id="minPdDd" placeholder="Min PD/DD" class="bg-gray-800 border border-gray-700 rounded p-2 text-sm w-full focus:border-blue-500 outline-none">
                            <input type="number" id="maxPdDd" placeholder="Max PD/DD" class="bg-gray-800 border border-gray-700 rounded p-2 text-sm w-full focus:border-blue-500 outline-none">
                        </div>
                    </div>

                    <!-- Teknik Analiz -->
                    <div>
                        <label class="text-xs text-gray-400 uppercase font-bold mb-2 block">Teknik Analiz (RSI)</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="number" id="minRsi" placeholder="Min RSI" class="bg-gray-800 border border-gray-700 rounded p-2 text-sm w-full focus:border-blue-500 outline-none">
                            <input type="number" id="maxRsi" placeholder="Max RSI" class="bg-gray-800 border border-gray-700 rounded p-2 text-sm w-full focus:border-blue-500 outline-none">
                        </div>
                    </div>

                    <!-- MACD -->
                    <div>
                        <label class="text-xs text-gray-400 uppercase font-bold mb-2 block">MACD Göstergeleri</label>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <input type="number" id="minMacdHist" placeholder="Min Hist" class="bg-gray-800 border border-gray-700 rounded p-2 text-sm w-full focus:border-blue-500 outline-none">
                            <input type="number" id="maxMacdHist" placeholder="Max Hist" class="bg-gray-800 border border-gray-700 rounded p-2 text-sm w-full focus:border-blue-500 outline-none">
                        </div>
                    </div>

                    <!-- Büyüme -->
                    <div>
                        <label class="text-xs text-gray-400 uppercase font-bold mb-2 block">Büyüme Oranı (%)</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="number" id="minBuyume" placeholder="Min %" class="bg-gray-800 border border-gray-700 rounded p-2 text-sm w-full focus:border-blue-500 outline-none">
                            <input type="number" id="maxBuyume" placeholder="Max %" class="bg-gray-800 border border-gray-700 rounded p-2 text-sm w-full focus:border-blue-500 outline-none">
                        </div>
                    </div>

                    <button onclick="verileriGetir()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg font-semibold transition">
                        Sonuçları Getir
                    </button>
                    <button onclick="temizle()" class="w-full bg-gray-700 hover:bg-gray-600 text-gray-300 py-2 rounded-lg text-sm transition">
                        Filtreleri Temizle
                    </button>
                </div>
            </div>
        </div>

        <!-- SAĞ PANEL: TABLO -->
        <div class="col-span-12 lg:col-span-9">
            <div class="glass rounded-xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-800 text-gray-400 text-xs uppercase tracking-wider">
                                <th class="p-4 font-semibold">Sembol</th>
                                <th class="p-4 font-semibold">Fiyat</th>
                                <th class="p-4 font-semibold text-blue-300">SMA 50</th>
                                <th class="p-4 font-semibold text-yellow-300">SMA 200</th>
                                <th class="p-4 font-semibold">RSI (14)</th>
                                <th class="p-4 font-semibold">TREND (ADX/DI)</th>
                                <th class="p-4 font-semibold">MACD Hist</th>
                                <th class="p-4 font-semibold">MACD Sinyal</th>
                                <th class="p-4 font-semibold">F/K</th>
                                <th class="p-4 font-semibold">PD/DD</th>
                                <th class="p-4 font-semibold">Büyüme</th>
                                <th class="p-4 font-semibold">Son Güncelleme</th>
                            </tr>
                        </thead>
                        <tbody id="hisseTablosu" class="divide-y divide-gray-700 text-sm">
                            <!-- Veriler Buraya Gelecek -->
                            <tr>
                                <td colspan="9" class="p-8 text-center text-gray-500">Veriler yükleniyor...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="mt-2 text-right text-xs text-gray-500">
                * Veriler API üzerinden çekilmektedir.
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT KISMI -->
    <script>
        // ⚠️ DİKKAT: C# API Port Numaranı Buraya Yaz (dotnet run dediğinde çıkan port)
        // Eğer yerel makinede çalıştırıyorsan burası geçerlidir.
        const API_BASE_URL = "http://localhost:5158/api/hisseler";

        // --- DEMO (MOCK) VERİLER (API Çalışmadığında Görünecek) ---
        const MOCK_DATA = [
            { sembol: "THYAO", fiyat: 273.50, rsi: 28.5, macdHist: 2.45, macdLine: 5.2, macdSignal: 2.75, fk: 3.2, pdDd: 0.8, buyumeOrani: 45.2, sonGuncelleme: new Date().toISOString() },
            { sembol: "ASELS", fiyat: 62.10, rsi: 45.0, macdHist: -0.5, macdLine: 1.2, macdSignal: 1.7, fk: 12.5, pdDd: 3.4, buyumeOrani: 12.8, sonGuncelleme: new Date().toISOString() },
            { sembol: "GARAN", fiyat: 85.30, rsi: 72.1, macdHist: 1.1, macdLine: 3.5, macdSignal: 2.4, fk: 4.1, pdDd: 1.1, buyumeOrani: 110.5, sonGuncelleme: new Date().toISOString() },
            { sembol: "EREGL", fiyat: 42.00, rsi: 35.0, macdHist: 0.05, macdLine: 0.1, macdSignal: 0.05, fk: 8.9, pdDd: 1.2, buyumeOrani: -5.2, sonGuncelleme: new Date().toISOString() },
            { sembol: "BINHO", fiyat: 225.00, rsi: 55.0, macdHist: -2.1, macdLine: -5.0, macdSignal: -2.9, fk: 25.0, pdDd: 8.5, buyumeOrani: -222.17, sonGuncelleme: new Date().toISOString() }
        ];

        async function verileriGetir() {
            const statusDiv = document.getElementById('connectionStatus');
            const tbody = document.getElementById('hisseTablosu');
            const messageArea = document.getElementById('messageArea');
            const demoBadge = document.getElementById('demoBadge');
            
            // Filtre Değerlerini Al
            const params = new URLSearchParams();
            addParam(params, 'minFk', 'minFk');
            addParam(params, 'maxFk', 'maxFk');
            addParam(params, 'minPdDd', 'minPdDd');
            addParam(params, 'maxPdDd', 'maxPdDd');
            addParam(params, 'minRsi', 'minRsi');
            addParam(params, 'maxRsi', 'maxRsi');
            addParam(params, 'minMacdHist', 'minMacdHist');
            addParam(params, 'maxMacdHist', 'maxMacdHist');
            addParam(params, 'minBuyumeOrani', 'minBuyume');
            addParam(params, 'maxBuyumeOrani', 'maxBuyume');

            try {
                statusDiv.innerHTML = '<span class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></span> Yükleniyor...';
                
                // API İsteği Atmayı Dene
                const response = await fetch(`${API_BASE_URL}?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                
                if (!response.ok) throw new Error("API Hatası");
                
                const data = await response.json();
                
                // BAŞARILI İSE:
                statusDiv.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> Bağlı (Online)';
                messageArea.classList.add('hidden');
                demoBadge.style.display = 'none';
                renderTable(data);

            } catch (error) {
                // HATA VARSA (DEMO MODUNA GEÇ):
                console.warn("API'ye bağlanılamadı, Demo moda geçiliyor:", error);
                
                statusDiv.innerHTML = '<span class="w-2 h-2 rounded-full bg-orange-500"></span> Demo Modu';
                messageArea.classList.remove('hidden');
                demoBadge.style.display = 'inline-block';
                
                // Sahte veriyi göster
                renderTable(MOCK_DATA);
            }
        }

        function addParam(params, apiName, inputId) {
            const val = document.getElementById(inputId).value;
            if (val) params.append(apiName, val);
        }

        function renderTable(data) {
            const tbody = document.getElementById('hisseTablosu');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="p-8 text-center text-gray-500">Kriterlere uygun hisse bulunamadı.</td></tr>';
                return;
            }

            data.forEach(h => {
                // Renklendirme Mantığı
                const rsiClass = h.rsi < 30 ? 'text-green-400 font-bold animate-pulse' : (h.rsi > 70 ? 'text-red-400 font-bold' : 'text-gray-300');
                const macdClass = h.macdHist > 0 ? 'text-green-400' : 'text-red-400';
                const buyumeClass = h.buyumeOrani > 0 ? 'text-green-400' : 'text-red-400';
                
                // Tarih Formatlama
                let tarih = "Bilinmiyor";
                if (h.sonGuncelleme) {
                    tarih = new Date(h.sonGuncelleme).toLocaleString('tr-TR');
                }

                const row = `
                        <tr class="hover:bg-gray-800 transition duration-150 border-b border-gray-800/50">
                            <td class="p-4 font-bold text-white">${h.sembol}</td>
                            <td class="p-4 text-blue-300 font-medium">${h.fiyat.toFixed(2)} ₺</td>
                            
                            <td class="p-4 ${h.fiyat > h.sma50 ? 'text-green-300 font-semibold' : 'text-gray-500'}">
                                ${h.sma50.toFixed(2)}
                            </td>

                            <td class="p-4 ${h.fiyat > h.sma200 ? 'text-yellow-300 font-semibold' : 'text-gray-500'}">
                                ${h.sma200.toFixed(2)}
                            </td>

                            <td class="p-4 ${rsiClass}">${h.rsi.toFixed(2)}</td>
                            
                            <td class="p-4">
                                <div class="flex flex-col">
                                    <span class="font-bold text-sm ${h.adx > 25 ? 'text-white' : 'text-gray-500'}">
                                        ADX: ${h.adx.toFixed(2)}
                                    </span>
                                    <div class="text-xs mt-1 flex gap-2 font-mono">
                                        <span class="text-green-400" title="+DI">+: ${h.dmp.toFixed(1)}</span>
                                        <span class="text-red-400" title="-DI">-: ${h.dmn.toFixed(1)}</span>
                                    </div>
                                </div>
                            </td>

                            <td class="p-4 ${macdClass}">${h.macdHist.toFixed(2)}</td>
                            
                            <td class="p-4 text-gray-400">
                                <div class="flex flex-col gap-1">
                                    <span class="text-xs bg-gray-700/50 px-1 rounded w-max">L: ${h.macdLine.toFixed(2)}</span>
                                    <span class="text-xs bg-gray-700/50 px-1 rounded w-max">S: ${h.macdSignal.toFixed(2)}</span>
                                </div>
                            </td>

                            <td class="p-4 text-gray-300">${h.fk.toFixed(2)}</td>
                            <td class="p-4 text-gray-300">${h.pdDd.toFixed(2)}</td>
                            <td class="p-4 ${buyumeClass} font-medium">%${h.buyumeOrani.toFixed(2)}</td>
                            <td class="p-4 text-xs text-gray-500">${tarih}</td>
                        </tr>
                    `;
                tbody.innerHTML += row;
            });
        }

        function temizle() {
            const inputs = document.querySelectorAll('input');
            inputs.forEach(i => i.value = '');
            verileriGetir();
        }

        // Sayfa açılınca verileri çek
        window.onload = verileriGetir;
    </script>
</body>
</html>